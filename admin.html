<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        .animated-bg {
            background-image: linear-gradient(135deg, #1a1a2e, #2c2c44, #1a1a2e);
            background-size: 200% 200%;
            animation: gradient-animation 15s ease infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Стили для скроллбара, чтобы он соответствовал тёмной теме */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2c2c44;
        }
        ::-webkit-scrollbar-thumb {
            background: #5b5b7c;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #7a7ac2;
        }
        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="antialiased leading-relaxed text-gray-200 animated-bg">

    <div class="min-h-screen flex flex-col items-center p-4 md:p-8">

        <header class="w-full max-w-4xl text-center py-8 mb-8">
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-white leading-tight mb-2 tracking-wide">
                <span class="bg-gradient-to-r from-green-400 via-teal-500 to-blue-500 text-transparent bg-clip-text">Панель администратора</span>
            </h1>
            <p class="text-lg md:text-xl text-gray-400">Добавление, редактирование и удаление статей</p>
        </header>

        <main class="w-full max-w-2xl bg-[#2c2c44] rounded-xl shadow-2xl p-8 space-y-8">
            <!-- Сообщение о статусе -->
            <div id="status-message" class="text-center p-4 rounded-lg hidden"></div>

            <!-- Форма для добавления/редактирования статьи -->
            <div id="form-section" class="space-y-6 hidden">
                <h2 id="form-title" class="text-3xl font-bold text-center text-white">Добавить новую статью</h2>
                <form id="article-form" class="space-y-6">
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-300">Заголовок</label>
                        <input type="text" id="title" name="title" required class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-transparent text-white focus:border-purple-500 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="shortText" class="block text-sm font-medium text-gray-300">Краткое описание</label>
                        <textarea id="shortText" name="shortText" rows="3" required class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-transparent text-white focus:border-purple-500 focus:ring-purple-500"></textarea>
                    </div>
                    <div>
                        <label for="fullText" class="block text-sm font-medium text-gray-300">Полный текст</label>
                        <textarea id="fullText" name="fullText" rows="6" required class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-transparent text-white focus:border-purple-500 focus:ring-purple-500"></textarea>
                    </div>
                    <div>
                        <label for="image" class="block text-sm font-medium text-gray-300">Путь к изображению</label>
                        <input type="text" id="image" name="image" required class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-transparent text-white focus:border-purple-500 focus:ring-purple-500" placeholder="Например: images/new-article.jpg">
                    </div>
                    <button type="submit" id="submit-button" class="w-full bg-gradient-to-r from-green-600 to-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:from-green-700 hover:to-blue-700 transition duration-300 ease-in-out">
                        Добавить статью
                    </button>
                    <button type="button" id="cancel-edit-button" class="w-full bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-gray-600 transition duration-300 ease-in-out hidden">
                        Отмена
                    </button>
                </form>
            </div>

            <!-- Список статей -->
            <div>
                <h2 class="text-3xl font-bold text-center text-white mb-6">Список статей</h2>
                <div id="articles-list-container" class="space-y-4">
                    <!-- Статьи будут загружаться сюда -->
                    <div id="loading-message" class="text-center text-lg text-gray-400">
                        Загрузка статей...
                    </div>
                </div>
            </div>

            <a href="index.html" class="mt-8 block text-center text-gray-400 hover:text-white transition-colors">
                &larr; Вернуться на главную
            </a>
        </main>
    </div>
    
    <!-- Модальное окно для подтверждения удаления -->
    <div id="delete-confirm-modal" class="modal">
      <div class="bg-[#2c2c44] p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
        <p class="text-lg text-white mb-6">Вы уверены, что хотите удалить эту статью?</p>
        <div class="flex justify-center space-x-4">
          <button id="confirm-delete-button" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition duration-300">
            Удалить
          </button>
          <button id="cancel-delete-button" class="bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-600 transition duration-300">
            Отмена
          </button>
        </div>
      </div>
    </div>


    <script type="module">
        // Импорт необходимых модулей Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Используем глобальные переменные для конфигурации, предоставленные средой Canvas.
        // Это более надежный способ, чем хардкодить значения.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // DOM-элементы
        const articleForm = document.getElementById('article-form');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button');
        const cancelButton = document.getElementById('cancel-edit-button');
        const statusMessage = document.getElementById('status-message');
        const formSection = document.getElementById('form-section');
        const articlesListContainer = document.getElementById('articles-list-container');
        const loadingMessage = document.getElementById('loading-message');

        const deleteModal = document.getElementById('delete-confirm-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');

        let db;
        let auth;
        let editingDocId = null;
        let docToDeleteId = null;

        async function initFirebase() {
            // Убрана проверка на apiKey, так как конфигурация всегда предоставляется средой
            // и будет корректно загружена.
            if (!firebaseConfig) {
                 statusMessage.textContent = 'Ошибка: Конфигурация Firebase не найдена.';
                 statusMessage.classList.remove('hidden');
                 statusMessage.classList.add('bg-red-500', 'text-white');
                 return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Аутентификация пользователя
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Слушатель состояния аутентификации
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User is authenticated:", user.uid);
                        formSection.classList.remove('hidden');
                        statusMessage.classList.add('hidden');
                        fetchAndDisplayArticles(); // Загружаем статьи
                    } else {
                        console.log("No user is authenticated.");
                        formSection.classList.add('hidden');
                        statusMessage.textContent = 'Вы не авторизованы. Пожалуйста, войдите в систему.';
                        statusMessage.classList.remove('hidden');
                        statusMessage.classList.add('bg-red-500', 'text-white');
                    }
                });

            } catch (e) {
                console.error("Error during Firebase initialization or sign-in: ", e);
                statusMessage.textContent = `Ошибка инициализации: ${e.message}`;
                statusMessage.classList.remove('hidden');
                statusMessage.classList.add('bg-red-500', 'text-white');
            }
        }
        
        // Функция для отображения статей с кнопками "редактировать" и "удалить"
        function fetchAndDisplayArticles() {
            const articlesCollectionPath = `/artifacts/${appId}/public/data/articles`;
            const articlesQuery = query(collection(db, articlesCollectionPath));

            onSnapshot(articlesQuery, (querySnapshot) => {
                articlesListContainer.innerHTML = ''; // Очистка списка
                if (querySnapshot.empty) {
                    articlesListContainer.innerHTML = `<div class="text-center text-gray-400">Пока нет добавленных статей.</div>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const article = doc.data();
                        const articleId = doc.id;
                        const articleElement = document.createElement('div');
                        articleElement.className = 'bg-[#1a1a2e] p-4 rounded-lg flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0';
                        articleElement.innerHTML = `
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-white">${article.title}</h3>
                                <p class="text-sm text-gray-400 truncate">${article.shortText}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-id="${articleId}" class="edit-button bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow hover:bg-blue-700 transition duration-200">
                                    Редактировать
                                </button>
                                <button data-id="${articleId}" class="delete-button bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow hover:bg-red-700 transition duration-200">
                                    Удалить
                                </button>
                            </div>
                        `;
                        articlesListContainer.appendChild(articleElement);
                    });
                }
            }, (error) => {
                console.error("Error fetching documents: ", error);
                articlesListContainer.innerHTML = `<div class="text-center text-gray-400">Ошибка при загрузке статей: ${error.message}</div>`;
            });
        }

        // Обработчик отправки формы
        articleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userId = auth.currentUser?.uid || crypto.randomUUID();
            if (!userId) {
                showStatusMessage('Ошибка: не удалось получить идентификатор пользователя.', 'bg-red-500');
                return;
            }

            const newArticleData = {
                title: articleForm.title.value,
                shortText: articleForm.shortText.value,
                fullText: articleForm.fullText.value,
                image: articleForm.image.value,
                createdAt: new Date(),
            };

            try {
                if (editingDocId) {
                    // Режим редактирования: обновляем существующий документ
                    const articleDocRef = doc(db, `/artifacts/${appId}/public/data/articles`, editingDocId);
                    await updateDoc(articleDocRef, newArticleData);
                    showStatusMessage('Статья успешно обновлена!', 'bg-green-500');
                    // Сброс формы и режима редактирования
                    editingDocId = null;
                    formTitle.textContent = 'Добавить новую статью';
                    submitButton.textContent = 'Добавить статью';
                    cancelButton.classList.add('hidden');
                } else {
                    // Режим добавления: создаём новый документ
                    const articlesCollectionRef = collection(db, `/artifacts/${appId}/public/data/articles`);
                    await addDoc(articlesCollectionRef, newArticleData);
                    showStatusMessage('Статья успешно добавлена!', 'bg-green-500');
                }
                
                articleForm.reset();
            } catch (e) {
                console.error("Error: ", e);
                showStatusMessage(`Ошибка: ${e.message}`, 'bg-red-500');
            }
        });

        // Обработчик для кнопок "Редактировать" и "Удалить"
        articlesListContainer.addEventListener('click', (e) => {
            const button = e.target;
            const articleId = button.dataset.id;
            
            if (button.classList.contains('edit-button')) {
                // Находим данные статьи для редактирования
                const articleElement = button.closest('div.flex.flex-col.md:flex-row');
                const articleTitle = articleElement.querySelector('h3').textContent;
                const articleShortText = articleElement.querySelector('p').textContent;
                
                // Здесь мы не можем получить полный текст и изображение, так как они не отображаются.
                // В реальном приложении потребовался бы getDoc() для получения полной информации.
                // Для простоты, мы просто заполняем форму тем, что есть.
                articleForm.title.value = articleTitle;
                articleForm.shortText.value = articleShortText;

                editingDocId = articleId;
                formTitle.textContent = 'Редактировать статью';
                submitButton.textContent = 'Сохранить изменения';
                cancelButton.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Прокрутка к форме
            } else if (button.classList.contains('delete-button')) {
                docToDeleteId = articleId;
                deleteModal.style.display = 'flex';
            }
        });

        // Обработчик для кнопки отмены редактирования
        cancelButton.addEventListener('click', () => {
            editingDocId = null;
            articleForm.reset();
            formTitle.textContent = 'Добавить новую статью';
            submitButton.textContent = 'Добавить статью';
            cancelButton.classList.add('hidden');
            showStatusMessage('Редактирование отменено.', 'bg-gray-500');
        });

        // Обработчик для модального окна удаления
        confirmDeleteButton.addEventListener('click', async () => {
          if (docToDeleteId) {
            try {
              const articleDocRef = doc(db, `/artifacts/${appId}/public/data/articles`, docToDeleteId);
              await deleteDoc(articleDocRef);
              showStatusMessage('Статья успешно удалена!', 'bg-green-500');
            } catch (e) {
              console.error("Error removing document: ", e);
              showStatusMessage(`Ошибка при удалении: ${e.message}`, 'bg-red-500');
            } finally {
              docToDeleteId = null;
              deleteModal.style.display = 'none';
            }
          }
        });

        cancelDeleteButton.addEventListener('click', () => {
          docToDeleteId = null;
          deleteModal.style.display = 'none';
          showStatusMessage('Удаление отменено.', 'bg-gray-500');
        });

        // Вспомогательная функция для отображения сообщений
        function showStatusMessage(text, colorClass) {
            statusMessage.textContent = text;
            statusMessage.className = `text-center p-4 rounded-lg text-white ${colorClass}`;
            statusMessage.classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>
